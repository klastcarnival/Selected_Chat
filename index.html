<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JSON ì¸ë±ìŠ¤ ì„ íƒ ì¶”ì¶œ ë° ìˆœì„œ ì •ë¦¬ ë„êµ¬</title>
<style>
/* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ ë° ìˆœì„œ ì •ë¦¬(Reorder) ê¸°ëŠ¥ ì¶”ê°€ */
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; color: #333; background-color: #f8f9fa; margin: 0; padding: 20px; }
.container { max-width: 1200px; margin: 0 auto; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
h1, h2, h3 { color: #212529; border-bottom: 2px solid #e9ecef; padding-bottom: 10px; margin-top: 2rem; margin-bottom: 1rem; }
h1 { font-size: 2rem; } h2 { font-size: 1.75rem; } h3 { font-size: 1.5rem; }
button, input[type="file"]::file-selector-button { border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 1rem; font-weight: 500; transition: background-color 0.2s ease; }
.btn-primary { background-color: #007bff; color: white; }
.btn-primary:hover { background-color: #0056b3; }
.btn-secondary { background-color: #6c757d; color: white; }
.btn-secondary:hover { background-color: #5a6268; }
.btn-danger { background-color: #dc3545; color: white; }
.btn-danger:hover { background-color: #c82333; }
.disabled-button { background-color: #adb5bd; cursor: not-allowed; }
#uploadedFileList { margin-top: 15px; padding: 15px; background-color: #f1f3f5; border-radius: 5px; }
#uploadedFileList div { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #dee2e6; }
#uploadedFileList div:last-child { border-bottom: none; }
#uploadedFileList button { background-color: #dc3545; color: white; padding: 5px 10px; font-size: 0.8rem; }
#processButton { margin-top: 15px; }
#status { font-weight: bold; color: #007bff; margin-top: 10px; }
#comparisonResult { margin-top: 10px; padding: 15px; background-color: #e6f7ff; border-left: 5px solid #007bff; }
.action-buttons { margin-bottom: 1rem; display: flex; gap: 10px; }
#selectionContainer, #searchResults { display: flex; flex-wrap: nowrap; gap: 16px; padding: 10px 0; overflow-x: auto; }
.selection-column { flex: 1; min-width: 280px; max-width: 320px; border: 1px solid #dee2e6; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); display: flex; flex-direction: column; background-color: #fff; }
.column-header { padding: 12px 16px; border-bottom: 1px solid #e9ecef; }
.column-header h4 { margin: 0; font-size: 1rem; word-break: break-all; }
.column-header p { margin: 4px 0 0; font-size: 0.9rem; color: #6c757d; }
.column-controls { display: flex; gap: 8px; padding: 12px 16px; border-bottom: 1px solid #e9ecef; }
.column-controls button { flex: 1; }
.column-content { padding: 12px 16px; overflow-y: auto; max-height: 400px; }
.index-item { margin-bottom: 10px; }
.item-header { display: flex; align-items: flex-start; }
.item-header input[type="checkbox"] { margin-top: 4px; margin-right: 10px; flex-shrink: 0; }
.item-label { cursor: pointer; flex-grow: 1; }
.item-label .preview { color: #495057; font-size: 0.9rem; display: block; margin-top: 2px; }
.index-detail { display: none; margin-top: 8px; padding: 10px; background-color: #f1f3f5; border-radius: 4px; font-size: 0.9rem; white-space: pre-wrap; word-break: break-all; }
#searchControls { display: flex; gap: 10px; margin-bottom: 15px; }
#searchInput { flex-grow: 1; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 1rem; }
#searchStatus { font-weight: bold; margin-bottom: 1rem; }
hr { border: 0; border-top: 1px solid #e9ecef; margin: 2rem 0; }
.search-result-header { font-weight: bold; margin-bottom: 8px; margin-top: 16px; display: block; }
.search-result-header:first-of-type { margin-top: 0; }

/* ğŸŒŸ ìˆœì„œ ì •ë¦¬(Reorder) ì „ìš© ìŠ¤íƒ€ì¼ */
.reorder-item {
    padding: 10px;
    margin-bottom: 8px;
    background-color: #ffffff;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    cursor: grab; /* ë“œë˜ê·¸ë¥¼ ìœ ë„í•˜ëŠ” ì»¤ì„œ */
    transition: box-shadow 0.2s, background-color 0.2s;
}
.reorder-item:hover {
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
}
.reorder-item.dragging {
    opacity: 0.5;
    background-color: #e6f7ff;
    border: 2px dashed #007bff;
}
.reorder-item-header {
    font-weight: bold;
    font-size: 0.95rem;
    cursor: pointer;
    display: block;
}
.reorder-item-preview {
    font-size: 0.85rem;
    color: #6c757d;
    display: block;
    margin-top: 2px;
}
</style>
</head>
<body>
<div class="container">
<h1>JSON ì¸ë±ìŠ¤ ì„ íƒ ì¶”ì¶œ ë° ìˆœì„œ ì •ë¦¬ ë„êµ¬</h1>

<section id="uploadSection">
<h2>1. JSON íŒŒì¼ ì—…ë¡œë“œ (ìµœëŒ€ 3ê°œ)</h2>
<p>â€» RisuAI ì±„íŒ… íŒŒì¼ì„ ì—¬ëŸ¬ ê°œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ìµœëŒ€ 3ê°œ)</p>
<input type="file" id="fileInput" multiple accept=".json">
<div id="uploadedFileList">í˜„ì¬ ë¡œë“œëœ íŒŒì¼ ì—†ìŒ</div>
<button id="processButton" class="btn-primary" onclick="processFiles()" disabled>ì¶”ì¶œ ëª©ë¡ ìƒì„± (ì´ <span id="fileCount">0</span>ê°œ íŒŒì¼)</button>
<div id="status"></div>
</section>

<hr>

<section id="comparisonResultSection" style="display: none;">
<h2>2. ë°ì´í„° ë¹„êµ ê²°ê³¼</h2>
<div id="comparisonResult"></div>
</section>

<section id="selectionSection" style="display: none;">
<h3>3. ì¶”ì¶œí•  ì¸ë±ìŠ¤ ì„ íƒ (í†µí•©/ê°œë³„)</h3>
<div class="action-buttons">
<button class="btn-secondary" onclick="toggleAllDetails('selectionContainer', true)">ì „ì²´ ì¸ë±ìŠ¤ í¼ì¹˜ê¸°</button>
<button class="btn-secondary" onclick="toggleAllDetails('selectionContainer', false)">ì „ì²´ ì¸ë±ìŠ¤ ì ‘ê¸°</button>
</div>
<div id="selectionContainer"></div>
</section>

<section id="searchSection" style="display: none;">
<h3>3.5. í‚¤ì›Œë“œ ê²€ìƒ‰ ë° ì„ íƒ</h3>
<div id="searchControls">
<input type="text" id="searchInput" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ë‘ ê¸€ì ì´ìƒ)">
<button class="btn-primary" onclick="searchAndDisplayResults()">ê²€ìƒ‰</button>
</div>
<div id="searchStatus"></div>
<div id="searchResults"></div>
</section>

<section id="reorderSection" style="display: none;">
    <hr>
    <h2>4. ì„ íƒëœ ì¸ë±ìŠ¤ ìˆœì„œ ì •ë¦¬ ë° í¸ì§‘</h2>
    <p>â¬†ï¸ ìœ„ì—ì„œ ì„ íƒëœ í•­ëª©ë“¤ì…ë‹ˆë‹¤. í•­ëª©ì„ ë“œë˜ê·¸ ì•¤ ë“œë¡­ìœ¼ë¡œ ì´ë™í•˜ì—¬ ìˆœì„œë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    <p>ğŸ’¡ ì°¸ê³ : ë“œë˜ê·¸ ì•¤ ë“œë¡­ì„ í•˜ê¸° ì „ê¹Œì§€ëŠ” ì‹œê°„ ìˆœì„œ(time)ê°€ ìœ ì§€ë©ë‹ˆë‹¤. ë“œë˜ê·¸ ì•¤ ë“œë¡­ì„ í•˜ë©´ ìˆ˜ë™ ì •ë ¬ ëª¨ë“œê°€ í™œì„±í™”ë˜ì–´ ê·¸ ìˆœì„œê°€ ë³´ì¡´ë©ë‹ˆë‹¤.</p>
    <div class="action-buttons">
        <button class="btn-secondary" onclick="toggleAllDetails('reorderList', true)">ì „ì²´ í¼ì¹˜ê¸°</button>
        <button class="btn-secondary" onclick="toggleAllDetails('reorderList', false)">ì „ì²´ ì ‘ê¸°</button>
        <button class="btn-danger" onclick="resetToTimeSort()">ì‹œê°„ ìˆœì„œë¡œ ì´ˆê¸°í™”</button> </div>
    <div id="reorderList" class="column-content" style="max-height: 500px; padding: 10px; border: 1px solid #ced4da; border-radius: 5px;">
        ì„ íƒëœ ì¸ë±ìŠ¤ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. ì™¼ìª½ ëª©ë¡ì—ì„œ í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.
    </div>
</section>

<section id="downloadSection" style="display: none;">
<hr>
<h2>5. ìµœì¢… ì¶”ì¶œ ë° ë‹¤ìš´ë¡œë“œ</h2>
<button class="btn-primary" onclick="extractAndDownload()">ì„ íƒ í•­ëª© ë‹¤ìš´ë¡œë“œ (í™”ë©´ì— ë³´ì´ëŠ” ìˆœì„œ ìœ ì§€)</button>
</section>

</div>

<script>
let fileData = [];Â 
let unifiedLength = 0;Â 
const selectedItemsMap = new Map(); 
// ğŸŒŸ ìˆ˜ë™ ì •ë ¬ ìƒíƒœë¥¼ ì¶”ì í•˜ëŠ” í”Œë˜ê·¸
let isManualOrderActive = false; 

function simpleHash(str) { let hash = 5381; for (let i = 0; i < str.length; i++) { hash = (hash * 33) ^ str.charCodeAt(i); } return hash >>> 0; }

async function handleFileSelect(event) {
const files = event.target.files;
if (files.length === 0) return;
document.getElementById('status').textContent = `íŒŒì¼ ì²˜ë¦¬ ì¤€ë¹„ ì¤‘...`;
for (const file of Array.from(files)) {
if (fileData.length >= 3) { alert(`ìµœëŒ€ 3ê°œ íŒŒì¼ë§Œ ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.`); continue; }
if (fileData.some(f => f.name === file.name)) continue;
document.getElementById('status').textContent = `íŒŒì¼ '${file.name}' ì½ëŠ” ì¤‘...`;
try {
const data = await new Promise((resolve, reject) => {
const reader = new FileReader();
reader.onload = e => resolve(e.target.result);
reader.onerror = e => reject(e);
reader.readAsText(file);
});
const fullObject = JSON.parse(data);
const dataArray = fullObject.data?.message;
if (!Array.isArray(dataArray)) throw new Error("JSONì´ 'data.message' ë°°ì—´ì„ í¬í•¨í•œ RisuAI ì±„íŒ… í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.");
dataArray.sort((a, b) => (a.time || 0) - (b.time || 0));
dataArray.forEach(item => { if (item) item._hash = simpleHash(JSON.stringify(item)); });
fileData.push({ name: file.name, data: dataArray });
} catch (error) {
alert(`'${file.name}' ì²˜ë¦¬ ì˜¤ë¥˜: ${error.message}`);
}
}
updateFileListUI();
event.target.value = '';
}
document.getElementById('fileInput').addEventListener('change', handleFileSelect);

function updateFileListUI() {
const listDiv = document.getElementById('uploadedFileList');
const processButton = document.getElementById('processButton');
const fileCountSpan = document.getElementById('fileCount');
if (fileData.length === 0) {
listDiv.innerHTML = 'í˜„ì¬ ë¡œë“œëœ íŒŒì¼ ì—†ìŒ';
processButton.disabled = true;
processButton.classList.add('disabled-button');
document.getElementById('status').textContent = '';
} else {
listDiv.innerHTML = fileData.map((f, i) =>
`<div><span>${i + 1}. ${f.name} (í•­ëª©: ${f.data.length})</span><button onclick="removeFile(${i})">ì‚­ì œ</button></div>`
).join('');
processButton.disabled = false;
processButton.classList.remove('disabled-button');
document.getElementById('status').textContent = `${fileData.length}ê°œ íŒŒì¼ ì¤€ë¹„ ì™„ë£Œ.`;
}
fileCountSpan.textContent = fileData.length;
// íŒŒì¼ ë¡œë“œì‹œ ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¹€
['comparisonResultSection', 'selectionSection', 'searchSection', 'reorderSection', 'downloadSection'].forEach(id => document.getElementById(id).style.display = 'none');
// íŒŒì¼ ëª©ë¡ì´ ë°”ë€Œë©´ selectedItemsMap ì´ˆê¸°í™” ë° ìˆ˜ë™ ì •ë ¬ ìƒíƒœ ì´ˆê¸°í™”
selectedItemsMap.clear();
isManualOrderActive = false; // íŒŒì¼ ë³€ê²½ ì‹œ ì´ˆê¸°í™”
}

function removeFile(index) {
if (confirm(`'${fileData[index].name}'ì„(ë¥¼) ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
fileData.splice(index, 1);
updateFileListUI();
}
}

function findUnifiedLength(dataArrays) {
if (dataArrays.length <= 1) return 0;
const minLength = Math.min(...dataArrays.map(arr => arr.length));
let unifiedLen = 0;
for (let i = 0; i < minLength; i++) {
if (dataArrays.slice(1).every(arr => arr[i]?._hash === dataArrays[0][i]?._hash)) unifiedLen++;
else break;
}
return unifiedLen;
}

function processFiles() {
if (fileData.length === 0) return;
document.getElementById('status').textContent = 'ë°ì´í„° ë¹„êµ ë° ëª©ë¡ ìƒì„± ì¤‘...';
setTimeout(() => {
unifiedLength = findUnifiedLength(fileData.map(f => f.data));
displayComparisonResult();
generateIndexSelection();
isManualOrderActive = false; // ìµœì´ˆ ëª©ë¡ ìƒì„± ì‹œ ì‹œê°„ ìˆœì„œê°€ ê¸°ë³¸
updateReorderList(); 
document.getElementById('status').textContent = 'ì¸ë±ìŠ¤ ëª©ë¡ ìƒì„± ì™„ë£Œ. í•­ëª©ì„ ì„ íƒí•˜ê³  ìˆœì„œë¥¼ ì •ë¦¬í•´ì£¼ì„¸ìš”.';
['comparisonResultSection', 'selectionSection', 'searchSection', 'reorderSection', 'downloadSection'].forEach(id => document.getElementById(id).style.display = 'block');
}, 50);
}

function displayComparisonResult() {
const resultDiv = document.getElementById('comparisonResult');
let html = '';
if (fileData.length === 1) {Â 
html += `âœ… ë‹¨ì¼ íŒŒì¼ ë¡œë“œ ì™„ë£Œ. ì „ì²´ ${fileData[0].data.length}ê°œ í•­ëª©ì´ í‘œì‹œë©ë‹ˆë‹¤.`;
} else if (unifiedLength > 0) {
html += `âœ… 1ë²ˆ ~ ${unifiedLength}ë²ˆ ì¸ë±ìŠ¤ê¹Œì§€ ë‚´ìš©ì´ ëª¨ë“  íŒŒì¼ì—ì„œ ë™ì¼í•©ë‹ˆë‹¤.`;
} else {
html += 'âš ï¸ ê³µí†µëœ ì¸ë±ìŠ¤ êµ¬ê°„ì´ ì—†ìŠµë‹ˆë‹¤. ëª¨ë“  ë‚´ìš©ì´ íŒŒì¼ë³„ë¡œ í‘œì‹œë©ë‹ˆë‹¤.';
}
resultDiv.innerHTML = html;
}

function generateIndexSelection() {
const container = document.getElementById('selectionContainer');
container.innerHTML = '';Â 
let finalHtml = '';
if (unifiedLength > 0) {
const columnId = "unifiedColumn";
const itemsHtml = fileData[0].data.slice(0, unifiedLength).map((item, i) => createIndexItemHtml('unified', i, 0, item, columnId)).join('');
finalHtml += createColumnHtml('í†µí•© ì¸ë±ìŠ¤', `1 - ${unifiedLength}`, columnId, itemsHtml);
}
fileData.forEach((file, fileIdx) => {
const individualItems = file.data.slice(unifiedLength);
if (individualItems.length > 0) {
const columnId = `individualColumn-${fileIdx}`;
const title = fileData.length === 1 ? `ì „ì²´ ì¸ë±ìŠ¤` : `[${file.name.replace(/\.json$/i, '')}] ê°œë³„ ì¸ë±ìŠ¤`;
const range = fileData.length === 1 ? `1 - ${file.data.length}` : `${unifiedLength + 1} - ${file.data.length}`;
const itemsHtml = individualItems.map((item, i) => createIndexItemHtml('individual', unifiedLength + i, fileIdx, item, columnId)).join('');
finalHtml += createColumnHtml(title, range, columnId, itemsHtml);
}
});
container.innerHTML = finalHtml;
}

function createColumnHtml(title, range, columnId, content) {
return `<div class="selection-column">
<div class="column-header">
<h4>${title}</h4>
<p>${range}</p>
</div>
<div class="column-controls">
<button class="btn-primary" onclick="toggleColumnSelection('${columnId}', true)">ì „ì²´ ì„ íƒ</button>
<button class="btn-secondary" onclick="toggleColumnSelection('${columnId}', false)">ì „ì²´ í•´ì œ</button>
</div>
<div class="column-content">${content}</div>
</div>`;
}

function createIndexItemHtml(type, itemIndex, fileIndex, item, columnId) {
const index = itemIndex + 1;
const uniqueKey = `${fileIndex}-${itemIndex}`; // íŒŒì¼ ì¸ë±ìŠ¤ + í•­ëª© ì¸ë±ìŠ¤ë¡œ ê³ ìœ  í‚¤ ìƒì„±
const content = (item.data || '').trim().replace(/\n/g, ' ').substring(0, 40) + '...';
const fileName = fileData[fileIndex]?.name.replace(/\.json$/i, '') || `File ${fileIndex + 1}`;
const fullContent = `Role: ${item.role || 'N/A'}\nData:\n${item.data || '[ë‚´ìš© ì—†ìŒ]'}\nOriginal File: ${fileName} (Index: ${index})`;

// onchange ì´ë²¤íŠ¸ê°€ ëª¨ë“  ì²´í¬ë°•ìŠ¤ì— ëª…í™•íˆ ì¶”ê°€ë¨
return `<div class="index-item">
<div class="item-header">
<input type="checkbox" id="check-${uniqueKey}" data-type="${type}" data-item-index="${itemIndex}" data-file-index="${fileIndex}" data-column-id="${columnId}" onchange="updateReorderList()">
<div class="item-label" onclick="toggleDetail(this)">
<strong>${type === 'unified' ? '[í†µí•©] ' : ''}${index} index</strong>
<span class="preview">${content}</span>
</div>
</div>
<div class="index-detail">${fullContent.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
</div>`;
}

function toggleAllDetails(containerId, shouldExpand) {
const container = document.getElementById(containerId);
if(container) {
container.querySelectorAll('.index-detail').forEach(detail => {
detail.style.display = shouldExpand ? 'block' : 'none';
});
}
}

function toggleColumnSelection(columnId, select) {
document.querySelectorAll(`input[data-column-id="${columnId}"]`).forEach(cb => {
cb.checked = select;
});
updateReorderList(); // ì „ì²´ ì„ íƒ/í•´ì œ í›„ ìˆœì„œ ëª©ë¡ ì—…ë°ì´íŠ¸
}

function toggleDetail(element) {
    // ê°€ì¥ ê°€ê¹Œìš´ í•­ëª© ì»¨í…Œì´ë„ˆë¥¼ ì°¾ìŠµë‹ˆë‹¤.
    const itemContainer = element.closest('.index-item') || element.closest('.reorder-item');
    if (!itemContainer) return;
    
    const detailDiv = itemContainer.querySelector('.index-detail');
    if (detailDiv) detailDiv.style.display = detailDiv.style.display === 'block' ? 'none' : 'block';
}

function searchAndDisplayResults() {
document.getElementById('searchStatus').textContent = `ğŸ” ê²€ìƒ‰ ì¤‘...`;
setTimeout(() => {
const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
const resultsDiv = document.getElementById('searchResults');
const statusDiv = document.getElementById('searchStatus');
resultsDiv.innerHTML = '';Â 
statusDiv.innerHTML = '';Â 
if (searchTerm.length < 2) {Â 
statusDiv.textContent = 'âš ï¸ ê²€ìƒ‰ì–´ëŠ” ë‘ ê¸€ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
return;
}
let totalMatches = 0;
let searchResultsData = [];
fileData.forEach((file, fileIdx) => {
let matchingItems = [];
file.data.forEach((item, itemIdx) => {
const searchTarget = `${item.data || ''} ${item.role || ''}`.toLowerCase();
if (item && searchTarget.includes(searchTerm)) {
matchingItems.push({ item: item, itemIndex: itemIdx });
}
});
if (matchingItems.length > 0) {
searchResultsData.push({
fileName: file.name,
fileIndex: fileIdx,
matches: matchingItems.length,
items: matchingItems
});
totalMatches += matchingItems.length;
}
});

if (totalMatches > 0) {
statusDiv.innerHTML = `âœ… ì´ ${totalMatches}ê°œì˜ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.
<div class="action-buttons">
<button class="btn-secondary" onclick="toggleAllDetails('searchResults', true)">ì „ì²´ ì¸ë±ìŠ¤ í¼ì¹˜ê¸°</button>
<button class="btn-secondary" onclick="toggleAllDetails('searchResults', false)">ì „ì²´ ì¸ë±ìŠ¤ ì ‘ê¸°</button>
</div>`;

let finalHtml = '';
searchResultsData.forEach((group) => {
const columnId = `searchColumn-${group.fileIndex}`;
const itemsHtml = group.items.map(match => createIndexItemHtml('search', match.itemIndex, group.fileIndex, match.item, columnId)).join('');
finalHtml += createColumnHtml(`[${group.fileName.replace(/\.json$/i, '')}]`, `${group.matches}ê°œ ì¼ì¹˜`, columnId, itemsHtml);
});
resultsDiv.innerHTML = finalHtml;
} else {
statusDiv.textContent = `âŒ '${searchTerm}'ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.`;
}

updateReorderList(); // ê²€ìƒ‰ í›„ ìˆœì„œ ëª©ë¡ ì—…ë°ì´íŠ¸
}, 50);
}

// ğŸŒŸ ìˆ˜ë™ ìˆœì„œ ì •ë ¬ì„ ì´ˆê¸°í™”í•˜ëŠ” í•¨ìˆ˜
function resetToTimeSort() {
    if(confirm("ìˆ˜ë™ìœ¼ë¡œ ë³€ê²½í•œ ìˆœì„œë¥¼ ë¬´ì‹œí•˜ê³ , ëª¨ë“  í•­ëª©ì„ ì‹œê°„ ìˆœì„œëŒ€ë¡œ ì¬ì •ë ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        isManualOrderActive = false;
        updateReorderList();
        document.getElementById('status').textContent = `âœ… ìˆœì„œê°€ ì‹œê°„ ìˆœì„œëŒ€ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.`;
    }
}

// ======================= ğŸŒŸ ìˆœì„œ ì •ë¦¬(Reorder) ë¡œì§ ê°œì„  (í•˜ì´ë¸Œë¦¬ë“œ ì •ë ¬) =======================

function updateReorderList() {
    const reorderList = document.getElementById('reorderList');
    
    // 1. í˜„ì¬ ì„ íƒëœ í•­ëª©ì˜ ê³ ìœ  í‚¤(uniqueKey)ë¥¼ ëª¨ë‘ ìˆ˜ì§‘í•˜ê³  Mapì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
    const checkedKeys = new Set();
    
    document.querySelectorAll('#selectionContainer input[type="checkbox"]:checked, #searchResults input[type="checkbox"]:checked').forEach(checkbox => {
        const { fileIndex, itemIndex } = checkbox.dataset;
        const uniqueKey = `${fileIndex}-${itemIndex}`;
        checkedKeys.add(uniqueKey);

        // Mapì— í•­ëª©ì´ ì—†ìœ¼ë©´ ìƒˆë¡œ ì¶”ê°€
        if (!selectedItemsMap.has(uniqueKey)) {
            const item = fileData[parseInt(fileIndex)]?.data[parseInt(itemIndex)];
            if (item) {
                const stableId = item.time || Date.now(); 
                selectedItemsMap.set(uniqueKey, { 
                    item, 
                    stableId: stableId 
                });
            }
        }
    });

    // 2. ì²´í¬ í•´ì œëœ í•­ëª© ì œê±°
    for (const key of selectedItemsMap.keys()) {
        if (!checkedKeys.has(key)) {
            selectedItemsMap.delete(key);
        }
    }

    if (selectedItemsMap.size === 0) {
        isManualOrderActive = false; // ëª©ë¡ì´ ë¹„ë©´ ìˆ˜ë™ ì •ë ¬ ìƒíƒœ ì´ˆê¸°í™”
    }

    let finalKeys = [];
    
    if (isManualOrderActive) {
        // MANUAL MODE: ìˆ˜ë™ ì •ë ¬ì´ ë°œìƒí–ˆìœ¼ë©´ ê·¸ ìˆœì„œë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.
        
        // A. í˜„ì¬ DOM ìˆœì„œ ê°€ì ¸ì˜¤ê¸° (ì‚¬ìš©ìê°€ ë“œë˜ê·¸ ì•¤ ë“œë¡­ìœ¼ë¡œ ì„¤ì •í•œ ìˆœì„œ)
        const currentReorderKeys = Array.from(reorderList.querySelectorAll('.reorder-item'))
            .map(div => div.dataset.uniqueKey);
        
        // B. DOM ìˆœì„œ ì¤‘, í˜„ì¬ë„ ì„ íƒëœ í•­ëª©ë§Œ ë‚¨ê¹ë‹ˆë‹¤. (ìˆ˜ë™ ìˆœì„œ ìœ ì§€)
        const existingKeysInOrder = currentReorderKeys.filter(key => selectedItemsMap.has(key)); 
        
        // C. ìƒˆë¡œ ì„ íƒëœ í•­ëª© (Mapì—ëŠ” ìˆì§€ë§Œ DOM ìˆœì„œì—ëŠ” ì—†ëŠ” í•­ëª©)ì„ ì°¾ìŠµë‹ˆë‹¤.
        const newlyAddedKeys = Array.from(selectedItemsMap.keys()).filter(key => !existingKeysInOrder.includes(key));

        // D. ìƒˆë¡œ ì¶”ê°€ëœ í•­ëª©ì€ time(stableId) ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ë’¤ì— ë¶™ì…ë‹ˆë‹¤.
        const sortedNewKeys = newlyAddedKeys.sort((keyA, keyB) => {
            const itemA = selectedItemsMap.get(keyA);
            const itemB = selectedItemsMap.get(keyB);
            return (itemA?.stableId || 0) - (itemB?.stableId || 0);
        });

        // E. ìµœì¢… ìˆœì„œ: ê¸°ì¡´ ìˆ˜ë™ ìˆœì„œ + ìƒˆë¡œ ì¶”ê°€ëœ í•­ëª©(time ìˆœ)
        finalKeys = [...existingKeysInOrder, ...sortedNewKeys];
        
    } else {
        // TIME SORT MODE (Default): ìˆ˜ë™ ì •ë ¬ì´ ì—†ì—ˆê±°ë‚˜ ì´ˆê¸°í™”ë˜ì—ˆìœ¼ë©´ ALL í•­ëª©ì„ time ìˆœìœ¼ë¡œ ì •ë ¬í•©ë‹ˆë‹¤.
        finalKeys = Array.from(selectedItemsMap.keys()).sort((keyA, keyB) => {
            const itemA = selectedItemsMap.get(keyA);
            const itemB = selectedItemsMap.get(keyB);
            return (itemA?.stableId || 0) - (itemB?.stableId || 0);
        });
    }
    
    // 4. HTML ìƒì„± ë° ì¬ë¶€ì°©
    const itemsHtml = finalKeys
        .map(key => createReorderItemHtml(key, selectedItemsMap.get(key).item))
        .join('');

    reorderList.innerHTML = itemsHtml || 'ì„ íƒëœ ì¸ë±ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤. ì™¼ìª½ ëª©ë¡ì—ì„œ í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.';
    
    // 5. ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë¦¬ìŠ¤ë„ˆ ì¬ë¶€ì°©
    reorderList.querySelectorAll('.reorder-item').forEach(item => {
        item.addEventListener('dragstart', handleDragStart);
        item.addEventListener('dragover', handleDragOver);
        item.addEventListener('drop', handleDrop);
        item.addEventListener('dragend', handleDragEnd);
    });
    
    document.getElementById('reorderSection').style.display = 'block';
    document.getElementById('status').textContent = `ì„ íƒ í•­ëª© ${finalKeys.length}ê°œ, ìˆœì„œ ì •ë¦¬ ëŒ€ê¸° ì¤‘. (ì •ë ¬ ëª¨ë“œ: ${isManualOrderActive ? 'ìˆ˜ë™ ìˆœì„œ ë³´ì¡´' : 'ì‹œê°„ ìˆœì„œ ìë™'})`;
}

function createReorderItemHtml(uniqueKey, item) {
    const [fileIndexStr, itemIndexStr] = uniqueKey.split('-');
    const fileIndex = parseInt(fileIndexStr);
    const itemIndex = parseInt(itemIndexStr);
    const index = itemIndex + 1;
    const fileName = fileData[fileIndex]?.name.replace(/\.json$/i, '') || `File ${fileIndex + 1}`;
    const content = (item.data || '').trim().replace(/\n/g, ' ').substring(0, 40) + '...';
    const fullContent = `Role: ${item.role || 'N/A'}\nData:\n${item.data || '[ë‚´ìš© ì—†ìŒ]'}\nOriginal File: ${fileName} (Index: ${index})`;

    return `<div class="reorder-item" draggable="true" data-unique-key="${uniqueKey}">
        <div class="reorder-item-header" onclick="toggleDetail(this)">
            [${fileName}] ${index} index
            <span class="reorder-item-preview">${content}</span>
        </div>
        <div class="index-detail">${fullContent.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
    </div>`;
}

// ğŸŒŸ ë“œë˜ê·¸ ì•¤ ë“œë¡­ í•¸ë“¤ëŸ¬ (ìˆ˜ë™ ì •ë ¬ ëª¨ë“œ í™œì„±í™”)
let draggedItem = null;

function handleDragStart(e) {
    draggedItem = this;
    // ğŸŒŸ ë“œë˜ê·¸ ì‹œì‘ ì‹œ ìˆ˜ë™ ì •ë ¬ ëª¨ë“œ í™œì„±í™”
    isManualOrderActive = true; 
    document.getElementById('status').textContent = `ì„ íƒ í•­ëª© ${selectedItemsMap.size}ê°œ, ìˆœì„œ ì •ë¦¬ ëŒ€ê¸° ì¤‘. (ì •ë ¬ ëª¨ë“œ: ìˆ˜ë™ ìˆœì„œ ë³´ì¡´)`;
    
    setTimeout(() => this.classList.add('dragging'), 0);
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.innerHTML);
}

function handleDragEnd(e) {
    this.classList.remove('dragging');
    draggedItem = null;
}

function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    const targetItem = this.closest('.reorder-item');
    if (targetItem && targetItem !== draggedItem) {
        const rect = targetItem.getBoundingClientRect();
        const next = (e.clientY - rect.top) / rect.height > 0.5;
        const parent = targetItem.parentNode;
        
        if (next) {
            parent.insertBefore(draggedItem, targetItem.nextSibling);
        } else {
            parent.insertBefore(draggedItem, targetItem);
        }
    }
}

function handleDrop(e) {
    e.stopPropagation();
    return false;
}
// =====================================================================

// ================== ìµœì¢… ì¶”ì¶œ ë° ë‹¤ìš´ë¡œë“œ (DOM ìˆœì„œ ì‚¬ìš©) ==================
function extractAndDownload() {
    // í™”ë©´ì— ë³´ì´ëŠ” DOM ìˆœì„œ ê·¸ëŒ€ë¡œ í•­ëª©ì„ ì¿¼ë¦¬í•©ë‹ˆë‹¤.
    const reorderList = document.getElementById('reorderList');
    const reorderedItems = reorderList.querySelectorAll('.reorder-item'); 
    
    if (reorderedItems.length === 0) { 
        alert('ì¶”ì¶œí•  ì¸ë±ìŠ¤ë¥¼ ì„ íƒí•˜ê±°ë‚˜, ìˆœì„œ ì •ë¦¬ ëª©ë¡ì´ ë¹„ì–´ìˆì§€ ì•Šì€ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.'); 
        return; 
    }
    
    let extractedData = [];
    const hashSet = new Set();
    
    // reorderedItemsì˜ ìˆœì„œëŒ€ë¡œ ë°ì´í„°ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.
    reorderedItems.forEach(reorderDiv => {
        const uniqueKey = reorderDiv.dataset.uniqueKey;
        const itemInfo = selectedItemsMap.get(uniqueKey);
        
        if (itemInfo && itemInfo.item && !hashSet.has(itemInfo.item._hash)) {
            const finalItem = { ...itemInfo.item };
            delete finalItem._hash; 
            extractedData.push(finalItem);
            hashSet.add(itemInfo.item._hash);
        }
    });
    
    if (extractedData.length === 0) { alert('ìœ íš¨í•œ ì¶”ì¶œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. ì¤‘ë³µ í•­ëª©ì´ ì œê±°ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.'); return; }
    
    // ìµœì¢… ë‹¤ìš´ë¡œë“œ JSON (RisuAI í¬ë§· ë³µì›)
    const finalOutputObject = {Â 
        type: "risuChat",Â 
        ver: 2,Â 
        data: {Â 
            message: extractedData,Â 
            note: "Messages reordered by user", 
            name: "Extracted Chat (Reordered)",Â 
            localLore: [],Â 
            fmIndex: -1,Â 
            id: `extracted-reordered-${Date.now()}`,Â 
            scriptstate: {
                "$rolecheck": "1",
                "$removechoice": "0",
                "$debug_reroll": null,
                "$debug_time": null
            },Â 
            lastMemory: "NewChat"Â 
        },Â 
        folders: []Â 
    };

    try {
        const jsonContent = JSON.stringify(finalOutputObject, null, 2);
        const blob = new Blob([jsonContent], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'reordered_ai_chat.json'; 
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert(`âœ… ${extractedData.length}ê°œ í•­ëª©ì´ ìˆœì„œ ì •ë¦¬ë˜ì–´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. (reordered_ai_chat.json)`);
    } catch (e) {
        alert(`âš ï¸ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜: ${e.message}`);
    }
}
// ======================================================================================
</script>
</body>
</html>
